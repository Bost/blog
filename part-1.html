<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-12-12 Tue 14:33 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Iterative, real-world script development, Part 1 - Quick'n'Dirty.</title>
<meta name="author" content="Rostislav Svoboda" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Iterative, real-world script development, Part 1 - Quick'n'Dirty.</h1>
<style>
blockquote {
    font-style: italic;
}
</style>

<p>
While reading the <a href="https://guix.gnu.org/manual/devel/en/guix.html">GNU Guix Reference Manual</a>, you may have come across this <a href="https://guix.gnu.org/manual/devel/en/guix.html#index-Git_002c-using-the-latest-commit">paragraph</a>:
</p>

<blockquote>
<p>
Checkouts are kept in a cache under <code>~/.cache/guix/checkouts</code> to speed up
consecutive accesses to the same repository. You may want to clean it up once in
a while to save disk space.
</p>
</blockquote>

<p>
After looking at your checkout cache, you might find the following:
</p>

<div class="org-src-container">
<pre class="src src-fish"><span style="color: #3a81c3;">ls</span> -d1 ~/.cache/guix/checkouts/* <span style="color: #4e3163;">|</span> <span style="color: #3a81c3;">wc</span> -l <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">--directory, 1 file per line; then count lines</span>
<span style="color: #3a81c3;">du</span> -sh ~/.cache/guix/checkouts           <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">get size; --summarize --human-readable</span>
</pre>
</div>

<pre class="example">
15
647M	/home/bost/.cache/guix/checkouts
</pre>


<p>
This shows that some disk space could be saved by cleaning the cache. As the
saying goes, "If you've got nothing better to do, go and clean up." However,
cleaning is inherently tedious and boring. It doesn't advance your
progress. And as we all learned in school, nothing stays clean forever due to
the ever-increasing entropy.
</p>

<p>
Wouldn't a little automation script for cleaning up the checkout cache be handy?
</p>

<div id="outline-container-org5260ad7" class="outline-2">
<h2 id="org5260ad7"><span class="section-number-2">1.</span> Quick Detour: The Guix-HPC Workshop</h2>
<div class="outline-text-2" id="text-1">
<p>
A couple of weeks ago, a Guix-HPC workshop was organized in Montpellier,
France. If you attended, you might have seen a group of people, presumably
scientists with non-computer science backgrounds, attending Ludo's
<a href="https://hpc.guix.info/events/2023/workshop/program/#how-to-get-started-using-guix"><i>"Get
Started"</i></a> tutorial. A smaller group, mostly computer geeks, attended Simon's
<a href="https://hpc.guix.info/events/2023/workshop/program/#how-to-make-advanced-packages"><i>"Advanced"</i></a>
tutorial, basically concluded with:
</p>

<blockquote>
<p>
Packaging is not easy &#x2013; Simon Tournier
</p>
</blockquote>

<p>
Apparently the non-CS folks need help with the initial steps, such as
introductions, explanations. After all Guix, as well as Nix, are both rather
<b>different</b> from anything we've seen before.
</p>

<p>
One of the challenges in using Guix might be its reliance on the Guile Scheme
language. While Guile is excellent for fine crafting, which includes configuring,
extending, and customizing your operating system, it's not necessarily the
best for quick-and-dirty scripting. Yes, it's possible <sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup><sup>, </sup><sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup>, but there are better tools for
rapidly piecing scripts together.
</p>
</div>
</div>


<div id="outline-container-orge8d1375" class="outline-2">
<h2 id="orge8d1375"><span class="section-number-2">2.</span> The Script</h2>
<div class="outline-text-2" id="text-2">
<p>
If quickly writing Guile scripts is demanding, why not try to develop a
prototype iteratively<sup><a id="fnr.3" class="footref" href="#fn.3" role="doc-backlink">3</a></sup> in a simpler environment? An environment with an
easy-to-read scripting language would be ideal. One such environment is the
<a href="https://fishshell.com/">Fish shell</a>, which features a scripting language similar to Python.
</p>

<p>
Returning to our original goal of writing a script for cleaning the checkout
cache: Your Guix system might use fewer channels than the number of items in
the checkout cache:
</p>

<div class="org-src-container">
<pre class="src src-fish"><span style="color: #3a81c3;">guix</span> system describe <span style="color: #4e3163;">|</span> <span style="color: #3a81c3;">grep</span> repository
</pre>
</div>

<pre class="example">
repository URL: https://github.com/Bost/haskell-guix
repository URL: https://github.com/Bost/guix-packages
repository URL: https://git.savannah.gnu.org/git/guix.git
repository URL: https://gitlab.com/nonguix/nonguix
</pre>


<p>
So, let's take a look at the items in the checkout cache directory:
</p>

<div class="org-src-container">
<pre class="src src-fish"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-d, --directory            list directories themselves, not their contents</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-1                         list one file per line</span>
<span style="color: #3a81c3;">ls</span> -d1 ~/.cache/guix/checkouts/*
</pre>
</div>

<pre class="example" id="orgaf62695">
/home/bost/.cache/guix/checkouts/63g3ea4meam7lf5mkodnht3ilpw6f2c7ptksrpy4ivkvcmez2voq
/home/bost/.cache/guix/checkouts/fooo
/home/bost/.cache/guix/checkouts/l74zueb3lgylhgxnuzx3d5fzraztxvzu2s4466wlqqvmz7hdct3a
/home/bost/.cache/guix/checkouts/last-expiry-cleanup
/home/bost/.cache/guix/checkouts/lfimhcs6pzfafrqnk5pkwua2o7xromo7q233lmyeynaqragzj7ya
/home/bost/.cache/guix/checkouts/lzgohq5qx5m3joiq7hpwhifey5cjhzdjh7ftgqf3zf6yscgpwmha
/home/bost/.cache/guix/checkouts/nvfgx2qw6oh46gsdlp4tqi7dpxqecwz5rxx3dako5hgvxm3t4emq
/home/bost/.cache/guix/checkouts/pjmkglp4t7znuugeurpurzikxq3tnlaywmisyr27shj7apsnalwq
/home/bost/.cache/guix/checkouts/q34vpblad6qjkemghxeewwgkxzw6b77mas5mipiiym7cjfph3s2q
/home/bost/.cache/guix/checkouts/qrpa3yqjnryavq6ke65ui2wfhxxce6yhkjjljfjwjnzxwrzir2kq
/home/bost/.cache/guix/checkouts/sbukdbdulb5sf3fmyaj7h2t3g3qd2tvif3p6fuw5rxvmbh5ocrxq
/home/bost/.cache/guix/checkouts/ssrrbehkhpdmb76h67z3j7zsfqgh2uuku2p5fpb75tndxp3uf4qa
/home/bost/.cache/guix/checkouts/xiy6tmf5c47m4mbsgcyscbv54puep4fsa4cxjvakkhvnwv5lhqma
/home/bost/.cache/guix/checkouts/xsxs5jlzxqsz5a7r3mygoglnval3uum5umz6jfmiwo3t7ltndu5a
/home/bost/.cache/guix/checkouts/zs6zmevqvbzp76b5g35peosmi6a6szehu3rvisbmfxclfwhyyida
</pre>


<p>
&#x2026; that's a plenty of checksums :headache:. This means we need to open each
directory in the checkout cache to see its contents and determine if it can be
deleted. This would have to be done manually, one by one :-(
</p>

<p>
If we start with the first one, we find that it is&#x2026;
</p>

<div class="org-src-container">
<pre class="src src-fish"><span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-A, --almost-all           do not list implied . and ..</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">-1                         list one file per line</span>
<span style="color: #3a81c3;">ls</span> -A1 /home/bost/.cache/guix/checkouts/63g3ea4meam7lf5mkodnht3ilpw6f2c7ptksrpy4ivkvcmez2voq
</pre>
</div>

<pre class="example" id="orge1ed27b">
COPYING
.dir-locals.el
games
.git
.guix-authorizations
.guix-channel
hacking.org
mono-mdoc-timestamping.patch
news.txt
readme.org
</pre>

<p>
&#x2026; a Git repository. Voilà! This means we can identify its origin:
</p>

<div class="org-src-container">
<pre class="src src-fish"><span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">checkout</span> /home/bost/.cache/guix/checkouts/63g3ea4meam7lf5mkodnht3ilpw6f2c7ptksrpy4ivkvcmez2voq
<span style="color: #3a81c3;">git</span> --git-dir=<span style="color: #2d9574;">$</span><span style="color: #715ab1;">checkout/</span>.git remote --verbose <span style="color: #4e3163;">|</span> <span style="color: #3a81c3;">grep</span> fetch
</pre>
</div>

<pre class="example">
origin	https://gitlab.com/guix-gaming-channels/games.git (fetch)
</pre>


<p>
And then compare it to see if it is one of the channel repositories:
</p>

<div class="org-src-container">
<pre class="src src-fish"><span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">rePattern</span> <span style="color: #2d9574;">"\(https\|http\|file\)\?://[^ ]\+"</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">URL regexp pattern</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "[DEBUG] rePattern:\n%s\n" $rePattern</span>
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">checkout</span> /home/bost/.cache/guix/checkouts/63g3ea4meam7lf5mkodnht3ilpw6f2c7ptksrpy4ivkvcmez2voq
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">checkoutURL</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">git</span> --git-dir=<span style="color: #2d9574;">$</span><span style="color: #715ab1;">checkout/</span>.git remote --verbose <span style="color: #4e3163;">|</span> <span style="color: #3a81c3;">grep</span> fetch <span style="color: #4e3163;">|</span> <span style="color: #3a81c3;">grep</span> -o <span style="color: #2d9574;">$</span><span style="color: #715ab1;">rePattern</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "[DEBUG] repo:\n%s\n" $repo</span>
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">checkoutCache</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">guix</span> system describe <span style="color: #4e3163;">|</span> <span style="color: #3a81c3;">grep</span> repository <span style="color: #4e3163;">|</span> <span style="color: #3a81c3;">grep</span> -o <span style="color: #2d9574;">$</span><span style="color: #715ab1;">rePattern</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "[DEBUG] checkoutCache:\n%s\n" $checkoutCache</span>
<span style="color: #3a81c3;">printf</span> <span style="color: #2d9574;">"Does my Guix system run code from... ?\n"</span>
<span style="color: #3a81c3;">printf</span> <span style="color: #2d9574;">"%s  %s\n"</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">contains</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">repo</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">checkoutCache</span> <span style="color: #3a81c3; font-weight: bold;">&amp;&amp;</span> <span style="color: #3a81c3;">echo</span> <span style="color: #2d9574;">"Yes"</span> <span style="color: #3a81c3; font-weight: bold;">||</span> <span style="color: #3a81c3;">echo</span> <span style="color: #2d9574;">"No "</span><span style="color: #3a81c3;">)</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">checkoutURL</span>
</pre>
</div>

<pre class="example">
Does my Guix system run code from... ?
No   https://gitlab.com/guix-gaming-channels/games.git
</pre>


<p>
Okay. Now, let's cobble all the pieces together, implementing multiple
improvements, strongly(!) preferring readability over elegance, etc.:
</p>

<div class="org-src-container">
<pre class="src src-fish"><span style="color: #2aa1ae; background-color: #ecf3ec;">#</span><span style="color: #2aa1ae; background-color: #ecf3ec;">!/usr/bin/env fish</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">From</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">https://guix.gnu.org/manual/devel/en/guix.html#index-Git_002c-using-the-latest-commit</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">"Checkouts are kept in a cache under ~/.cache/guix/checkouts to speed up</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#  </span><span style="color: #2aa1ae; background-color: #ecf3ec;">consecutive accesses to the same repository. You may want to clean it up once</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#  </span><span style="color: #2aa1ae; background-color: #ecf3ec;">in a while to save disk space."</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">This script prints out a list of shell script commands (active of commented</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">out), and remarks which can be executed of further refined.</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The path must not be surrounded by double quotes, i.e. it must NOT be a</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">string.</span>
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">checkoutCache</span> ~/.cache/guix/checkouts

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">regular expression for matching an URL</span>
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">regexp</span> <span style="color: #2d9574;">"\(https\|http\|file\)\?://[^ ]\+"</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "[DEBUG] regexp:\n%s\n" $regexp</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">### </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Be away that printing arrays in Fish can be tricky</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">find items under $checkoutCache which are directories</span>
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">cacheDirs</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">find</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">checkoutCache</span> -mindepth <span style="color: #4e3163;">1</span> -maxdepth <span style="color: #4e3163;">1</span> -type d<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "[DEBUG] %s cacheDirs:\n" (count $cacheDirs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "%s\n" $cacheDirs</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">find items under $checkoutCache which are NOT directories</span>
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">cacheNonDirs</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">find</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">checkoutCache</span> -mindepth <span style="color: #4e3163;">1</span> -maxdepth <span style="color: #4e3163;">1</span> -not -type d<span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "[DEBUG] %s cacheNonDirs:\n" (count $cacheNonDirs)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "%s\n" $cacheNonDirs</span>

<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">allChannelRepos</span> <span style="color: #3a81c3;">(</span>guix system describe <span style="color: #4e3163;">|</span> <span style="color: #4e3163;">\</span>
                     <span style="color: #3a81c3;">grep</span> repository <span style="color: #4e3163;">|</span> <span style="color: #3a81c3;">grep</span> --only-matching <span style="color: #2d9574;">"$regexp"</span><span style="color: #3a81c3;">)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "[DEBUG] %s allChannelRepos:\n" (count $allChannelRepos)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "%s\n" (string join \n $allChannelRepos)</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Define empty variables which will serve as arrays. Can't use:</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">#    </span><span style="color: #2aa1ae; background-color: #ecf3ec;">set &lt;variable&gt; ""  # some comment</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">since that creates a variable containing an empty string.</span>
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">keepDirs</span>       <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">local clones of git repositories actively used &amp; cached</span>
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">keepURLs</span>       <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">fetch-URLs of these clones</span>
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">removeDirs</span>     <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">inactive clones ...</span>
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">removeURLs</span>     <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">... and theirs fetch-URLs</span>
<span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">others</span>         <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">other, non-git-repository items in the checkout cache</span>

<span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">dir</span> in <span style="color: #2d9574;">$</span><span style="color: #715ab1;">cacheDirs</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "[DEBUG] dir: %s\n" $dir</span>
    <span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">dirGit</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">dir/</span>.git
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">test</span> -d <span style="color: #2d9574;">$</span><span style="color: #715ab1;">dirGit</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">is ... a directory?</span>
        <span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">dirURL</span> <span style="color: #3a81c3;">(</span>git --git-dir=<span style="color: #2d9574;">$</span><span style="color: #715ab1;">dirGit</span> remote --verbose <span style="color: #4e3163;">|</span> <span style="color: #4e3163;">\</span>
                    <span style="color: #3a81c3;">grep</span> fetch <span style="color: #4e3163;">|</span> <span style="color: #3a81c3;">grep</span> --only-matching <span style="color: #2d9574;">"$regexp"</span><span style="color: #3a81c3;">)</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "[DEBUG] dirURL: %s\n" $dirURL</span>
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">contains</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">dirURL</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">allChannelRepos</span>
            <span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">--append</span> keepDirs <span style="color: #2d9574;">$</span><span style="color: #715ab1;">dir</span>
            <span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">--append</span> keepURLs <span style="color: #2d9574;">$</span><span style="color: #715ab1;">dirURL</span>
        <span style="color: #3a81c3; font-weight: bold;">else</span>
            <span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">--append</span> removeDirs <span style="color: #2d9574;">$</span><span style="color: #715ab1;">dir</span>
            <span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">--append</span> removeURLs <span style="color: #2d9574;">$</span><span style="color: #715ab1;">dirURL</span>
        <span style="color: #3a81c3; font-weight: bold;">end</span>
    <span style="color: #3a81c3; font-weight: bold;">else</span>
        <span style="color: #3a81c3; font-weight: bold;">set</span> <span style="color: #715ab1;">--append</span> others <span style="color: #2d9574;">$</span><span style="color: #715ab1;">dir</span>
    <span style="color: #3a81c3; font-weight: bold;">end</span>
<span style="color: #3a81c3; font-weight: bold;">end</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">test -n "$&lt;variable&gt;":</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">$&lt;variable&gt; surrounded by double quotes gets converted to a string. By</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">testing if such a string has a non-zero length we ask if the $&lt;variable&gt; is</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">a void value?</span>

<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">test</span> -n <span style="color: #2d9574;">"$removeDirs"</span>
    <span style="color: #3a81c3;">printf</span> <span style="color: #2d9574;">"### %s Cached checkouts to delete:\n"</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">count</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">removeDirs</span><span style="color: #3a81c3;">)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The array size of $removeDirs and $removeURLs are the same</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #715ab1;">i</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">seq </span><span style="color: #6c3163;">(</span><span style="color: #2d9574;">count $removeDirs</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">printf "%s # %s\n" $removeDirs[$i] $removeURLs[$i]</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Don't delete it the straight away. Just mark it for deletetion by</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">renaming it. And even that in a dry-run. Better safe than sorry.</span>
        <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(Thank me later ;-)</span>
        <span style="color: #3a81c3;">printf</span> <span style="color: #2d9574;">"mv %s{,.deleteMe}  # %s\n"</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">removeDirs</span><span style="color: #3a81c3;">[</span><span style="color: #2d9574;">$</span><span style="color: #715ab1;">i</span><span style="color: #3a81c3;">]</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">removeURLs</span><span style="color: #3a81c3;">[</span><span style="color: #2d9574;">$</span><span style="color: #715ab1;">i</span><span style="color: #3a81c3;">]</span>
    <span style="color: #3a81c3; font-weight: bold;">end</span>
<span style="color: #3a81c3; font-weight: bold;">end</span>

<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">test</span> -n <span style="color: #2d9574;">"$keepDirs"</span>
    <span style="color: #3a81c3;">printf</span> <span style="color: #2d9574;">"\n### %s Cached checkouts to keep:\n"</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">count</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">keepDirs</span><span style="color: #3a81c3;">)</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The array size of $keepDirs and $keepURLs are the same</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #715ab1;">i</span> <span style="color: #3a81c3; font-weight: bold;">in</span> <span style="color: #3a81c3;">(</span><span style="color: #2d9574;">seq </span><span style="color: #6c3163;">(</span><span style="color: #2d9574;">count $keepDirs</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
        <span style="color: #3a81c3;">printf</span> <span style="color: #2d9574;">"# %s  # %s\n"</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">keepDirs</span><span style="color: #3a81c3;">[</span><span style="color: #2d9574;">$</span><span style="color: #715ab1;">i</span><span style="color: #3a81c3;">]</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">keepURLs</span><span style="color: #3a81c3;">[</span><span style="color: #2d9574;">$</span><span style="color: #715ab1;">i</span><span style="color: #3a81c3;">]</span>
    <span style="color: #3a81c3; font-weight: bold;">end</span>
<span style="color: #3a81c3; font-weight: bold;">end</span>

<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">test</span> -n <span style="color: #2d9574;">"$cacheNonDirs"</span>
    <span style="color: #3a81c3;">printf</span> <span style="color: #2d9574;">"\n### %s Non-directory items in the checkout cache directory:\n"</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">count</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">cacheNonDirs</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">elem</span> in <span style="color: #2d9574;">$</span><span style="color: #715ab1;">cacheNonDirs</span>
        <span style="color: #3a81c3;">printf</span> <span style="color: #2d9574;">"# %s\n"</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">elem</span>
    <span style="color: #3a81c3; font-weight: bold;">end</span>
<span style="color: #3a81c3; font-weight: bold;">end</span>
<span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3; font-weight: bold;">test</span> -n <span style="color: #2d9574;">"$others"</span>
    <span style="color: #3a81c3;">printf</span> <span style="color: #2d9574;">"\n### %s Other items in the checkout cache directory:\n"</span> <span style="color: #3a81c3;">(</span><span style="color: #3a81c3;">count</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">others</span><span style="color: #3a81c3;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #3a81c3;">elem</span> in <span style="color: #2d9574;">$</span><span style="color: #715ab1;">others</span>
        <span style="color: #3a81c3;">printf</span> <span style="color: #2d9574;">"# %s\n"</span> <span style="color: #2d9574;">$</span><span style="color: #715ab1;">elem</span>
    <span style="color: #3a81c3; font-weight: bold;">end</span>
<span style="color: #3a81c3; font-weight: bold;">end</span>
</pre>
</div>
<pre class="example" id="orgb313249">
### 9 Cached checkouts to delete:
mv /home/bost/.cache/guix/checkouts/zs6zmevqvbzp76b5g35peosmi6a6szehu3rvisbmfxclfwhyyida{,.deleteMe}  # https://gitlab.inria.fr/guix-hpc/guix-past
mv /home/bost/.cache/guix/checkouts/qrpa3yqjnryavq6ke65ui2wfhxxce6yhkjjljfjwjnzxwrzir2kq{,.deleteMe}  # https://git.sr.ht/~abcdw/rde
mv /home/bost/.cache/guix/checkouts/lzgohq5qx5m3joiq7hpwhifey5cjhzdjh7ftgqf3zf6yscgpwmha{,.deleteMe}  # file:///home/bost/dev/andrew-rde
mv /home/bost/.cache/guix/checkouts/xiy6tmf5c47m4mbsgcyscbv54puep4fsa4cxjvakkhvnwv5lhqma{,.deleteMe}  # https://codeberg.org/SystemCrafters/crafted-guix.git
mv /home/bost/.cache/guix/checkouts/lfimhcs6pzfafrqnk5pkwua2o7xromo7q233lmyeynaqragzj7ya{,.deleteMe}  # file:///home/bost/dev/haskell-guix
mv /home/bost/.cache/guix/checkouts/q34vpblad6qjkemghxeewwgkxzw6b77mas5mipiiym7cjfph3s2q{,.deleteMe}  # https://gitlab.com/virt-viewer/virt-viewer
mv /home/bost/.cache/guix/checkouts/63g3ea4meam7lf5mkodnht3ilpw6f2c7ptksrpy4ivkvcmez2voq{,.deleteMe}  # https://gitlab.com/guix-gaming-channels/games.git
mv /home/bost/.cache/guix/checkouts/xsxs5jlzxqsz5a7r3mygoglnval3uum5umz6jfmiwo3t7ltndu5a{,.deleteMe}  # https://github.com/engstrand-config/home-service-dwl-guile
mv /home/bost/.cache/guix/checkouts/sbukdbdulb5sf3fmyaj7h2t3g3qd2tvif3p6fuw5rxvmbh5ocrxq{,.deleteMe}  # file:///home/bost/dev/guix-packages

### 4 Cached checkouts to keep:
# /home/bost/.cache/guix/checkouts/l74zueb3lgylhgxnuzx3d5fzraztxvzu2s4466wlqqvmz7hdct3a  # https://gitlab.com/nonguix/nonguix
# /home/bost/.cache/guix/checkouts/nvfgx2qw6oh46gsdlp4tqi7dpxqecwz5rxx3dako5hgvxm3t4emq  # https://github.com/Bost/haskell-guix
# /home/bost/.cache/guix/checkouts/pjmkglp4t7znuugeurpurzikxq3tnlaywmisyr27shj7apsnalwq  # https://git.savannah.gnu.org/git/guix.git
# /home/bost/.cache/guix/checkouts/ssrrbehkhpdmb76h67z3j7zsfqgh2uuku2p5fpb75tndxp3uf4qa  # https://github.com/Bost/guix-packages

### 1 Non-directory items in the checkout cache directory:
# /home/bost/.cache/guix/checkouts/last-expiry-cleanup

### 1 Other items in the checkout cache directory:
# /home/bost/.cache/guix/checkouts/fooo
</pre>

<p>
It wasn't too complicated, although I admit it took me quite some time to work
it out.  Here's a breakdown of the script's key points:
</p>

<ol class="org-ol">
<li>The script input is:
<ul class="org-ul">
<li>The checkout cache directory <code>~/.cache/guix/checkouts</code>, and</li>
<li>Information extractable from <code>guix system describe</code>.</li>
</ul></li>
<li>The script processes information using:
<ul class="org-ul">
<li>Utilities provided by the operating system: <code>grep</code>, <code>git</code>, <code>find</code>, <code>guix</code>, etc.</li>
<li>Command composition via the pipe operator '|'.</li>
<li>Iteration over arrays and sequences (think lists).</li>
<li>Repeated tests against a predicate: <code>contains $checkoutURL $allChannelRepos</code>.</li>
<li>Branching based on the <code>contains ...</code> test's results.</li>
<li>Sorting the results into distinct containers.</li>
</ul></li>
<li>The script outputs a list of shell commands with additional information for
verifying correctness. However, this aspect "is left as an exercise for the
reader".</li>
</ol>

<p>
In upcoming blog posts, we will address some of these points and reimplement
the script in Guile Scheme. This will allow for better integration with the
Guix operating system.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">See
<a href="https://www.gnu.org/software/guile/manual/html_node/Scripting-Examples.html">scripting
examples</a> from The Guile Reference Manual.</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">See
<a href="https://archive.softwareheritage.org/browse/directory/179f060aabd198e758b52058b417fee1a7b8962c/?origin_url=https://gitlab.com/zimoun/advanced-packages-2023&amp;path=examples/scripts&amp;revision=e2b1a61486e8b7d75200231cf645b5442373f048&amp;snapshot=909e690430f6d869f78c6b56abc0e8cbb895ea8d">scripting
examples</a> from Simon's
<a href="https://hpc.guix.info/events/2023/workshop/program/#how-to-make-advanced-packages"><i>"How
to make advanced packages"</i></a> tutorial.</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3" role="doc-backlink">3</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
The sequences:
</p>
<pre class="example" id="org9007bc3">
some commands
</pre>

<pre class="example" id="orgf451316">
command results
</pre>
<p class="footpara">
are examples of using <a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a> techniques. Some strong <i>literate
programming</i>-fu was presented at the workshop by Marek Felšöci in the
<a href="https://hpc.guix.info/events/2023/workshop/program/#how-to-use-org-mode-and-guix-to-build-a-reproducible-experimental-study"><i>"Reproducible studies in Org mode"</i></a> tutorial.
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="date">Date: December 12, 2023</p>
<p class="author">Author: Rostislav Svoboda</p>
<p class="date">Created: 2023-12-12 Tue 14:33</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
